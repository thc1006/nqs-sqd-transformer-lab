# NQS-SQD 實驗記錄

> 本文件記錄所有實驗嘗試、發現與結論，以便追蹤研究進度。

---

## 目錄

1. [專案目標](#專案目標)
2. [實驗記錄](#實驗記錄)
   - [2024-11-28 實驗一：VMC 能量參考點修正](#2024-11-28-實驗一vmc-能量參考點修正)
   - [2024-11-28 實驗二：Adam vs SR 優化器比較](#2024-11-28-實驗二adam-vs-sr-優化器比較)
   - [2024-11-28 實驗三：FFNN 架構規模掃描](#2024-11-28-實驗三ffnn-架構規模掃描)
   - [2024-11-28 實驗四：Transformer NQS vs FFNN 比較](#2024-11-28-實驗四transformer-nqs-vs-ffnn-比較)
   - [2024-11-28 實驗五：網路文獻調研 - 20.5 mHa 瓶頸分析](#2024-11-28-實驗五網路文獻調研---205-mha-瓶頸分析)
   - [2024-11-28 實驗六：粒子數約束測試](#2024-11-28-實驗六粒子數約束測試)
3. [目前狀態總結](#目前狀態總結更新)
4. [參考資料](#參考資料)

---

## 專案目標

研究 **Neural Quantum States (NQS)** 作為 **Sample-based Quantum Diagonalization (SQD)** 的取樣器，目標是：

1. 比較 FFNN NQS 與 Transformer NQS 的表現
2. 研究不同取樣器對 SQD 樣本效率的影響
3. 達到化學精度 (Chemical Accuracy): **1.6 mHa**

### 系統配置

| 項目 | 規格 |
|------|------|
| GPU | NVIDIA RTX 4090 |
| 測試分子 | H₂ (氫分子) |
| 鍵長 | 0.74 Å |
| 量子位元 | 4-bit (STO-3G) / 12-bit (擴展) |
| FCI 能量 | -1.137284 Ha (總能量) |
| 電子 FCI | -1.852388 Ha (電子能量) |

---

## 實驗記錄

### 2024-11-28 實驗一：VMC 能量參考點修正

#### 問題描述

原始測試報告顯示 VMC 誤差為 **694 mHa (61%)**，這個數字異常地高。

#### 根本原因分析

經過調查發現是**能量參考點錯誤**：

| 比較項目 | 錯誤做法 | 正確做法 |
|----------|----------|----------|
| VMC 輸出 | 電子能量 (~-1.83 Ha) | 電子能量 (~-1.83 Ha) |
| FCI 參考 | 總能量 (-1.14 Ha) ❌ | 電子 FCI (-1.85 Ha) ✅ |
| 差異 | 包含核排斥能 (0.715 Ha) | 純電子能量比較 |

**關鍵公式：**
```
E_total = E_electronic + E_nuclear_repulsion
-1.137 Ha = -1.852 Ha + 0.715 Ha
```

VMC 的 Hamiltonian 只包含電子項，所以輸出的是電子能量，必須與 `electronic_fci_energy` 比較，而非 `fci_energy`。

#### 修正方案

1. 在 `H2Hamiltonian` 類別新增 `electronic_fci_energy` 屬性：

```python
@property
def electronic_fci_energy(self) -> float | None:
    """電子 FCI 能量（不含核排斥）"""
    if self.fci_energy is None:
        return None
    return self.fci_energy - self.nuclear_repulsion
```

2. 更新 `vmc_trainer.py` 使用正確的參考能量

#### 修正後結果

| 系統 | 修正前誤差 | 修正後誤差 |
|------|-----------|-----------|
| 4-qubit H₂ | 694 mHa (錯誤) | **20.53 mHa** |
| 12-qubit H₂ | 694 mHa (錯誤) | **20.52 mHa** |

#### 結論

- ✅ VMC 實際上運作正常
- ✅ ~20 mHa 誤差是合理的（雖然仍未達化學精度）
- ✅ 程式碼已修正並推送至 GitHub

---

### 2024-11-28 實驗二：Adam vs SR 優化器比較

#### 實驗目的

測試 Stochastic Reconfiguration (SR) 優化器是否能改善 VMC 收斂性。SR 使用量子 Fisher 資訊矩陣計算自然梯度。

#### 實驗設定

| 參數 | Adam | SR |
|------|------|-----|
| 學習率 | 5e-3 | 0.05 |
| 正則化 | - | ε = 0.01 |
| 模型 | FFNN(64, 2) | FFNN(64, 2) |
| Epochs | 200 | 200 |
| 系統 | 4-qubit H₂ | 4-qubit H₂ |

#### 實驗結果

| 優化器 | 最終誤差 | 訓練時間 |
|--------|----------|----------|
| Adam | **20.525 mHa** | 1.0 s |
| SR | **20.525 mHa** | 9.6 s |

#### 關鍵發現

🔴 **兩種優化器收斂到完全相同的能量！**

這表示：
1. 問題**不是**優化器的選擇
2. FFNN 架構本身存在表達能力限制
3. 模型卡在某個局部最小值（或可能是全域最小值對於此架構）

#### 結論

- ❌ SR 優化器無法改善最終精度
- ✅ SR 在某些情況下可能有更穩定的收斂
- ⚠️ 瓶頸在於模型架構，而非優化方法

---

### 2024-11-28 實驗三：FFNN 架構規模掃描

#### 實驗目的

測試增加 FFNN 參數量是否能提升表達能力並降低誤差。

#### 實驗設定

| 架構 | 隱藏層大小 | 層數 | 參數量 |
|------|-----------|------|--------|
| FFNN(64, 2) | 64 | 2 | 4,545 |
| FFNN(256, 3) | 256 | 3 | 133,121 |
| FFNN(512, 4) | 512 | 4 | 791,041 |

其他設定：
- 優化器：Adam (lr=5e-3)
- Epochs：300-500
- 排程器：Cosine annealing

#### 實驗結果

| 架構 | 參數量 | 最終誤差 |
|------|--------|----------|
| FFNN(64, 2) | 4,545 | **20.531 mHa** |
| FFNN(256, 3) | 133,121 | **20.525 mHa** |
| FFNN(512, 4) | 791,041 | NaN (不穩定) |

#### 關鍵發現

🔴 **增加參數量完全無法降低誤差！**

所有穩定的模型都收斂到相同的 ~20.5 mHa：

```
4,545 參數   → 20.531 mHa
133,121 參數 → 20.525 mHa  (參數增加 29 倍，誤差僅降 0.006 mHa)
```

#### 分析

這個 20.5 mHa 的「地板效應」說明：

1. **FFNN 表達能力有上限**：無論多少參數，都無法表達真實基態波函數
2. **可能原因**：
   - 實數波函數限制（缺少相位資訊）
   - 缺乏對稱性約束（粒子數守恆）
   - ReLU 激活函數的限制
   - 缺乏明確的關聯因子（Jastrow factor）

#### 結論

- ❌ 增大 FFNN 架構無法突破 20.5 mHa
- ⚠️ FFNN 表達能力是根本瓶頸
- ➡️ 需要嘗試不同架構（Transformer NQS）或物理約束

---

### 2024-11-28 實驗四：Transformer NQS vs FFNN 比較

#### 實驗目的

測試自迴歸 Transformer NQS 是否能突破 FFNN 的 20.5 mHa 瓶頸。Transformer 使用注意力機制，理論上能更好地捕捉長程關聯。

#### 實驗設定

| 參數 | FFNN | Transformer |
|------|------|-------------|
| 架構 | MLP(128, 3 layers) | d=64, heads=4, layers=2 |
| 參數量 | 33,793 | 100,417 |
| 學習率 | 5e-3 | 3e-3 |
| Epochs | 300 | 300 |
| 排程器 | Cosine | Cosine |
| Warmup | 20 epochs | 30 epochs |

#### 實驗結果

| 模型 | 參數量 | 最終誤差 | 訓練時間 |
|------|--------|----------|----------|
| FFNN | 33,793 | **20.525 mHa** | 1.2 s |
| Transformer | 100,417 | **20.602 mHa** | 1.2 s |

#### 關鍵發現

🔴 **Transformer 也收斂到相同的 ~20.5 mHa！**

這是一個極為重要的發現：

```
FFNN:        20.525 mHa
Transformer: 20.602 mHa
差異:         0.077 mHa (可忽略)
```

兩種**完全不同的架構**都收斂到相同的能量，這強烈暗示：

1. **這不是架構問題** - 無論 MLP 還是 Transformer 都達到相同極限
2. **這可能是波函數表示的根本限制**
3. **20.5 mHa 可能就是實數 NQS 的表達極限**

#### 深入分析

##### 可能的根本原因

1. **實數波函數的限制**
   - 目前：log ψ(x) = f_θ(x)（實數）
   - 問題：無法表達量子干涉效應
   - 解法：需要複數波函數 ψ(x) = |ψ(x)| e^{iφ(x)}

2. **缺乏物理對稱性**
   - 問題：模型可以表達任意函數，包括非物理解
   - 解法：強制粒子數守恆 N = 2

3. **完備基底的問題**
   - 4-qubit H₂ 只有 2^4 = 16 個配置
   - 可能需要更嚴格的配置選擇

##### 20.5 mHa 的意義

這個數字大約是：
- FCI 能量的 ~1.1%
- 化學精度的 ~13 倍
- 可能對應於某種「實數 NQS」的變分上界

#### 結論

- ❌ Transformer NQS 無法突破 20.5 mHa
- ❌ 架構選擇（FFNN vs Transformer）不是問題
- 🔴 **根本瓶頸：實數波函數表示 + 缺乏物理約束**
- ➡️ 下一步：實現粒子數約束或複數波函數

---

## 目前狀態總結

### 已完成

- [x] 修正能量參考點錯誤
- [x] 測試 Adam vs SR 優化器
- [x] FFNN 架構規模掃描
- [x] 確認 FFNN 的表達能力限制
- [x] 測試 Transformer NQS
- [x] 確認架構類型不是瓶頸

### 關鍵數據

| 指標 | 數值 |
|------|------|
| 目標（化學精度） | 1.6 mHa |
| FFNN 最佳結果 | 20.525 mHa |
| Transformer 結果 | 20.602 mHa |
| 差距 | **約 12-13 倍** |

### 瓶頸分析

```
化學精度目標: 1.6 mHa
      ↑
      | 需要 ~12x 改進
      ↓
NQS 極限: 20.5 mHa ← 實數波函數 + 缺乏對稱性
      ↑
      | 優化器、參數量、架構類型都無法突破
      ↓
當前最佳: 20.5 mHa (FFNN ≈ Transformer)
```

### 確定不是問題的因素

| 因素 | 測試方式 | 結論 |
|------|----------|------|
| 優化器 | Adam vs SR | ❌ 無影響 |
| 參數量 | 4K → 133K | ❌ 無影響 |
| 架構類型 | FFNN vs Transformer | ❌ 無影響 |

---

## 待辦事項

### 高優先級（突破 20.5 mHa）

1. ~~**測試 Transformer NQS**~~ ✅ 已完成（無改善）

2. **新增粒子數約束**（下一步）
   - H₂ 有 2 個電子
   - 只考慮 N=2 的配置
   - 大幅減少希爾伯特空間維度

3. **嘗試複數波函數**
   - 目前：ψ(x) = exp(f_θ(x))（實數）
   - 改進：ψ(x) = exp(f_θ(x) + i·g_φ(x))（複數）
   - 可能是根本解決方案

### 中優先級

4. **更換激活函數**
   - ReLU → SiLU/GELU（更平滑的梯度）
   - 可能改善訓練穩定性

5. **檢查 Hamiltonian 正確性**
   - 驗證 qubit Hamiltonian 與 FCI 結果一致
   - 確認 Jordan-Wigner 變換無誤

### 最終目標

6. **SQD 整合**
   - 使用訓練好的 NQS 作為 SQD 取樣器
   - 比較樣本效率：隨機 vs FFNN vs Transformer

---

### 2024-11-28 實驗五：網路文獻調研 - 20.5 mHa 瓶頸分析

#### 調研目的

進行大規模網路檢索，了解 NQS 達到化學精度的關鍵因素，以及我們 20.5 mHa 瓶頸的可能原因。

#### 關鍵發現

##### 1. 符號問題 (Sign Problem)

根據 [arXiv:2002.04613](https://arxiv.org/abs/2002.04613)：

> "Convolutional networks struggle to converge to ground states with a nontrivial sign structure."

- NQS 在有**非平凡符號結構**的系統中難以收斂
- 研究發現 NQS 可能卡在符合「Marshall 符號規則」的低能態，而非真正基態
- 這解釋了為何不同架構（FFNN、Transformer）都收斂到相同能量

##### 2. FermiNet 與 PauliNet 的成功秘訣

根據 [DeepMind FermiNet](https://deepmind.google/discover/blog/ferminet-quantum-physics-and-chemistry-from-first-principles/)：

| 特性 | 我們的 NQS | FermiNet/PauliNet |
|------|-----------|-------------------|
| 波函數形式 | 簡單 log ψ(x) | 多電子 Slater 行列式 |
| 反對稱性 | ❌ 無明確強制 | ✅ 結構性保證 |
| 精度 | ~98.9% | **99.9%+** |
| 關聯能 | 部分捕捉 | 完整捕捉 |

**關鍵引用**：
> "FermiNet and PauliNet are capable of recovering **99% or more** of the correlation energy across a diverse set of molecules."
>
> "PauliNet could reach **99.9%** of the correct energy within tens of minutes on a single GPU."

##### 3. Qubit 空間的特殊性

我們在 **qubit 空間**（Jordan-Wigner 變換後）工作：

- Jordan-Wigner 變換已經編碼了費米子反對稱性
- 但 NQS 在 qubit 空間是「盲目」的 - 它不知道哪些配置是物理的
- **H₂ 的 4-qubit 系統**：
  - 只有 |1100⟩ 和 |0011⟩ 可以貢獻基態（粒子數守恆）
  - 但 NQS 嘗試學習全部 2^4 = 16 個配置

##### 4. 實際限制 vs 理論表達能力

根據 [Nature Physics](https://www.nature.com/articles/s41567-024-02566-1)：

> "There is the emergence of a **practical limitation to reach universal representability**... practical calculations with NQS-based ansätze can differ considerably from the asymptotic behavior predicted by universal representation theorems."

這表示：
- 理論上 NQS 可以表達任意量子態
- 但**實際優化過程**可能無法找到正確的參數
- 這就是為何增加參數量無法改善我們的結果

##### 5. SR 優化器的符號問題

根據 [arXiv:2510.02051](https://arxiv.org/html/2510.02051)：

> "The stochastic reconfiguration method faces challenges when training log-amplitude and phase networks simultaneously... The faster changes of log-amplitude affect the Markov chain greatly, impeding the phase network's ability to converge to a correct sign structure."

建議：
- 對振幅和相位使用**不同的學習率**
- 考慮分階段訓練

#### 根本原因總結

```
我們的 20.5 mHa 瓶頸原因：

1. 缺乏物理約束
   └── NQS 不知道只有 N=2 的配置是有效的

2. 實數波函數
   └── 無法表達複雜的相位結構

3. 符號問題
   └── 優化器卡在錯誤的符號配置

4. Qubit 空間的「盲目性」
   └── NQS 沒有利用 Jordan-Wigner 的結構
```

#### 解決方案建議

| 優先級 | 方案 | 預期效果 | 複雜度 |
|--------|------|----------|--------|
| 1 | 粒子數約束 | 可能突破至 <10 mHa | 低 |
| 2 | 複數波函數 | 解決符號問題 | 中 |
| 3 | 使用 FermiNet/PauliNet | 達到 <1 mHa | 高 |
| 4 | 分階段振幅/相位訓練 | 改善收斂 | 中 |

#### 下一步行動

**立即嘗試：粒子數約束**

H₂ 的 4-qubit 系統中，只有以下配置是物理有效的（粒子數 N=2）：

| 配置 | 二進制 | 粒子數 |
|------|--------|--------|
| |1100⟩ | 1100 | 2 ✅ |
| |1010⟩ | 1010 | 2 ✅ |
| |1001⟩ | 1001 | 2 ✅ |
| |0110⟩ | 0110 | 2 ✅ |
| |0101⟩ | 0101 | 2 ✅ |
| |0011⟩ | 0011 | 2 ✅ |

共 C(4,2) = 6 個有效配置，遠小於 16 個全配置。

#### 參考文獻

1. [Neural network wave functions and the sign problem (PRR 2020)](https://arxiv.org/abs/2002.04613)
2. [FermiNet: Quantum Physics and Chemistry from First Principles (DeepMind)](https://deepmind.google/discover/blog/ferminet-quantum-physics-and-chemistry-from-first-principles/)
3. [Empowering deep neural quantum states through efficient optimization (Nature Physics 2024)](https://www.nature.com/articles/s41567-024-02566-1)
4. [Improving neural network performance for solving quantum sign structure (arXiv 2024)](https://arxiv.org/html/2510.02051)
5. [Efficiency of neural quantum states in light of the quantum geometric tensor (Comm Physics 2025)](https://www.nature.com/articles/s42005-025-02005-4)

---

### 2024-11-28 實驗六：粒子數約束測試

#### 實驗目的

測試限制配置空間到固定粒子數 N=2 是否能突破 20.5 mHa 瓶頸。

#### 假設

根據文獻調研結果，我們假設 20.5 mHa 瓶頸可能是因為：
- NQS 分配振幅給非物理配置（N ≠ 2）
- 限制到有效配置可能改善波函數品質

#### 實現方案

新增 `enumerate_configurations_fixed_n()` 函數，只生成粒子數 = N 的配置：

```python
def enumerate_configurations_fixed_n(
    n_qubits: int,
    n_particles: int,
    device: torch.device,
) -> torch.Tensor:
    """只生成粒子數 = n_particles 的配置。"""
    from itertools import combinations
    valid_configs = []
    for positions in combinations(range(n_qubits), n_particles):
        config = [0.0] * n_qubits
        for pos in positions:
            config[pos] = 1.0
        valid_configs.append(config)
    return torch.tensor(valid_configs, dtype=torch.float32, device=device)
```

VMCConfig 新增選項：
- `use_particle_constraint: bool = False`
- `n_particles: Optional[int] = None`

#### 實驗設定

| 參數 | 無約束 | 有約束 (N=2) |
|------|--------|--------------|
| 系統 | 4-qubit H₂ | 4-qubit H₂ |
| 配置數 | 16 (2^4) | 6 (C(4,2)) |
| 模型 | FFNN(64, 2) | FFNN(64, 2) |
| 學習率 | 5e-3 | 5e-3 |
| Epochs | 200 | 200 |

#### 實驗結果

| 測試 | 配置數 | 最終誤差 |
|------|--------|----------|
| 無約束 | 16 | **20.534 mHa** |
| N=2 約束 | 6 | **20.526 mHa** |

**改進量：0.008 mHa (0.0%)**

#### 關鍵發現

🔴 **粒子數約束對誤差幾乎沒有影響！**

```
無約束:  20.534 mHa (16 配置)
有約束:  20.526 mHa (6 配置)
改進:     0.008 mHa → 可忽略
```

這個結果極為重要，它告訴我們：

1. **瓶頸不是配置空間大小**
   - 即使只考慮物理有效的 6 個配置，仍然是 20.5 mHa

2. **NQS 已經正確識別了有效配置**
   - 無約束模型可能自己學會了忽略 N≠2 的配置

3. **根本問題是符號/相位結構**
   - 實數 NQS 無法表達基態波函數的正確符號結構

#### 與文獻對照

根據實驗五的調研，符號問題 (Sign Problem) 是 NQS 的主要障礙：

> "NQS 可能卡在符合 Marshall 符號規則的低能態，而非真正基態"

我們的實驗結果完全符合這個觀點：
- 粒子數約束解決不了符號問題
- 需要複數波函數或明確的符號結構

#### H₂ 基態符號分析

對於 4-qubit H₂，FCI 基態波函數大約是：

```
|ψ_GS⟩ ≈ 0.99 |1100⟩ - 0.14 |0011⟩ + ... (其他貢獻較小)
```

注意 |0011⟩ 的係數是**負的**！

實數 NQS 只能表達：
- ψ(x) = exp(f(x)) > 0  （全正）
- 或 ψ(x) = -exp(f(x)) < 0 （全負）

但無法表達混合符號的波函數。

#### 結論

- ❌ 粒子數約束無法改善精度
- ✅ 確認 NQS 已能正確識別有效配置
- 🔴 **瓶頸確定為：實數波函數無法表達正確的符號結構**

#### 下一步建議

根據本次實驗結果，建議的優先順序：

| 優先級 | 方案 | 預期效果 | 狀態 |
|--------|------|----------|------|
| ~~1~~ | ~~粒子數約束~~ | ~~無效~~ | ✅ 已驗證無效 |
| 1 | **複數波函數** | 解決符號問題 | 待實作 |
| 2 | SQD 整合 | 用目前 NQS 作為 sampler | 待實作 |
| 3 | FermiNet 架構 | 達到 <1 mHa | 長期 |

**複數波函數實作建議**：

```python
# 目前（實數）：
log_psi_real = model(x)  # 純實數

# 改進（複數）：
log_amplitude = model_amp(x)   # |ψ|
phase = model_phase(x)         # φ ∈ [0, 2π)
log_psi = log_amplitude + 1j * phase
```

---

### 2024-11-28 實驗七：複數波函數 NQS 測試 🎉

#### 實驗目的

基於實驗五和六的分析，測試複數波函數是否能解決符號問題並突破 20.5 mHa 瓶頸。

#### 理論背景

**符號問題分析**：
- H₂ 精確基態（4-qubit）：|ψ_GS⟩ ≈ **-0.994**|0101⟩ + **+0.113**|1010⟩
- 注意：|0101⟩ 和 |1010⟩ 的係數**符號相反**！

**實數 NQS 的限制**：
```
ψ_real(x) = exp(f(x)) > 0  ← 永遠為正，無法表達負係數
```

**複數 NQS 的解決方案**：
```
ψ_complex(x) = |ψ(x)| × exp(i × φ(x))

其中：
- |ψ(x)|: 振幅（由 amplitude network 學習）
- φ(x): 相位（由 phase network 學習）
- φ = 0 → cos(0) = +1 → 正係數
- φ = π → cos(π) = -1 → 負係數
```

#### 實作方案

新增 `ComplexFFNNNQS` 類別在 `src/nqs_models/ffn_nqs.py`：

```python
class ComplexFFNNNQS(nn.Module):
    """複數波函數 NQS：ψ(x) = |ψ(x)| × exp(i × φ(x))"""

    def __init__(self, config: FFNNNQSConfig):
        # 振幅網路：輸出 log|ψ(x)|
        self.amplitude_net = ...  # Tanh 激活

        # 相位網路：輸出 φ(x) ∈ [0, 2π)
        self.phase_net = ...  # 2π × sigmoid
```

新增 `ComplexVMCTrainer` 類別在 `src/training/vmc_trainer.py`：
- 處理複數局部能量計算
- 正確的 VMC 梯度公式（包含相位梯度）

#### 實驗設定

| 參數 | 數值 |
|------|------|
| 系統 | 4-qubit H₂ |
| 模型 | ComplexFFNNNQS(32, 2 layers) |
| 參數量 | ~2x 實數版本（振幅 + 相位網路）|
| 粒子數約束 | N=2 (6 配置) |
| 學習率 | 5e-3 |
| Epochs | 2000 |
| 排程器 | Cosine annealing |
| Warmup | 100 epochs |

#### 實驗結果

##### 對照組：實數 NQS

| 模型 | Epochs | 最終誤差 |
|------|--------|----------|
| FFNNNQS (實數) | 300 | **20.531 mHa** |

##### 實驗組：複數 NQS

| 模型 | Epochs | 最終誤差 |
|------|--------|----------|
| ComplexFFNNNQS | 2000 | **0.047 mHa** ✅ |

#### 收斂曲線

```
Epoch    0: 892.053 mHa  ← 隨機初始化
Epoch  200:  19.826 mHa  ← 快速下降
Epoch  400:  11.074 mHa
Epoch  600:   0.333 mHa  ← 突破化學精度！
Epoch  800:   0.134 mHa
Epoch 1000:   0.084 mHa
Epoch 1200:   0.063 mHa
Epoch 1400:   0.054 mHa
Epoch 1600:   0.049 mHa
Epoch 1800:   0.047 mHa
Epoch 2000:   0.047 mHa  ← 收斂
```

#### 學習到的波函數分析

| 配置 | |ψ| | 相位 (rad) | cos(φ) | 有效振幅 | 精確值 |
|------|------|-----------|--------|----------|--------|
| |0101⟩ | 0.9936 | 3.875 | -0.742 | **-0.738** | -0.994 |
| |1010⟩ | 0.1123 | 0.734 | +0.742 | **+0.083** | +0.113 |

**關鍵觀察**：
1. ✅ 振幅比例正確：0.9936 : 0.1123 ≈ 8.8:1（精確值 8.8:1）
2. ✅ 相位差 = 3.875 - 0.734 = **3.14 rad ≈ π**（相反符號！）
3. ✅ 模型正確學會了 |0101⟩ 為負、|1010⟩ 為正

#### 關鍵發現

🎉 **複數波函數成功解決符號問題！**

```
實數 NQS:  20.531 mHa → 無法表達負係數
複數 NQS:   0.047 mHa → 學會正確的相位結構
改進:      435 倍!
```

##### 成功關鍵因素

1. **複數波函數表示**
   - 相位網路學會對不同配置賦予不同相位
   - φ ≈ π 表示負係數，φ ≈ 0 表示正係數

2. **粒子數約束**
   - 減少無效配置的干擾
   - 從 16 個配置減少到 6 個

3. **足夠的訓練時間**
   - 需要 ~600 epochs 才能突破化學精度
   - 2000 epochs 達到完全收斂

#### 與文獻對照

實驗五調研的預測完全正確：

| 預測 | 實驗結果 |
|------|----------|
| "符號問題是主要瓶頸" | ✅ 複數波函數解決了此問題 |
| "需要複數表示" | ✅ 從 20.5 → 0.05 mHa |
| "相位優化困難" | ⚠️ 需要較長訓練時間 |

#### 結論

- ✅ **化學精度達成！** 0.047 mHa << 1.6 mHa
- ✅ 符號問題是 20.5 mHa 瓶頸的根本原因
- ✅ 複數波函數 + 粒子約束是正確的解決方案
- ⚠️ 需要較長訓練時間（~2000 epochs vs 300 epochs）

#### 下一步

- [x] 將最佳 ComplexNQS 整合到 SQD pipeline
- [ ] 測試更大系統（12-qubit H₂）
- [ ] 比較 NQS sampler vs 隨機 sampler 的樣本效率（大系統）

---

### 2024-11-28 實驗八：NQS-SQD 整合測試 ✅

#### 實驗目的

將訓練好的 ComplexFFNNNQS 模型整合到 qiskit-addon-sqd pipeline，測試 NQS 取樣器是否能提升 SQD 的樣本效率。

#### 技術挑戰與解決

##### 1. 積分格式問題

**問題**：使用手動 einsum 轉換的雙電子積分導致 SQD 誤差高達 311 mHa。

```python
# 錯誤方式（給出 4.87 的 (00|00) 積分）
eri_ao = mol.intor("int2e")
eri = np.einsum("pi,qj,rk,sl,ijkl->pqrs", mo_coeff, mo_coeff, mo_coeff, mo_coeff, eri_ao)
```

**解決**：使用 pyscf 的 `ao2mo` 模組正確處理積分格式。

```python
# 正確方式（給出 0.67 的 (00|00) 積分）
eri_packed = ao2mo.kernel(mol, mo_coeff)
eri = ao2mo.restore(1, eri_packed, n_spatial)
```

##### 2. 自旋態過濾

**問題**：NQS 在 qubit 空間訓練，包含非物理配置（如 |0101⟩ 有 0α+2β 電子）。

**解決**：新增自旋態過濾功能。

```python
# ComplexFFNNSampler 現在支援 (n_α, n_β) 過濾
sampler = ComplexFFNNSampler(
    model=nqs_model,
    device=device,
    n_alpha=1,  # H₂ 有 1 個 α 電子
    n_beta=1,   # H₂ 有 1 個 β 電子
)
```

##### 3. Bitstring 格式轉換

**問題**：NQS 輸出 (interleaved spin-orbital) 與 SQD 輸入格式不同。

**解決**：實作 `_convert_bitstrings_to_sqd_format()` 函數。

```
NQS format:  [0α, 0β, 1α, 1β]
SQD format:  [β₁, β₀, α₁, α₀]
```

#### 實驗結果

| Sampler | 樣本數 | 唯一配置數 | SQD 誤差 |
|---------|--------|-----------|----------|
| Random  | 100-1000 | 4 | **0.000 mHa** |
| NQS     | 100-1000 | 4 | **0.000 mHa** |

#### 分析

🔸 **兩者都達到精確 FCI 能量！**

這是因為 4-qubit H₂ 系統太小：
- 只有 4 個物理有效配置（1α, 1β）
- 隨機取樣和 NQS 取樣都能快速找到全部配置
- SQD 子空間維度 = 4（已達最大）

```
物理配置空間: C(2,1) × C(2,1) = 4 配置
|1100⟩: α 在軌道 0, β 在軌道 0（雙佔據）
|1001⟩: α 在軌道 0, β 在軌道 1
|0110⟩: α 在軌道 1, β 在軌道 0
|0011⟩: α 在軌道 1, β 在軌道 1（雙佔據）
```

#### 關鍵發現

1. ✅ **SQD 整合成功** - 達到精確 FCI 能量
2. ✅ **積分格式問題已解決** - 使用 ao2mo.kernel()
3. ⚠️ **4-qubit 系統太小** - 無法展示 NQS 的樣本效率優勢
4. ➡️ **需要更大系統** - 如 12-qubit H₂ 或更大分子

#### 下一步

要展示 NQS 取樣器的優勢，需要：
1. 使用更大的分子系統（12-qubit H₂）
2. 配置空間足夠大，使隨機取樣無法快速覆蓋
3. 比較達到目標精度所需的樣本數

---

## 目前狀態總結（更新）

### 已完成測試

| 因素 | 測試方式 | 結果 | 結論 |
|------|----------|------|------|
| 優化器 | Adam vs SR | 20.5 mHa 相同 | ❌ 非瓶頸 |
| 參數量 | 4K → 133K | 20.5 mHa 相同 | ❌ 非瓶頸 |
| 架構類型 | FFNN vs Transformer | 20.5 mHa 相同 | ❌ 非瓶頸 |
| 粒子數約束 | 16 vs 6 配置 | 20.5 mHa 相同 | ❌ 單獨使用無效 |
| **複數波函數** | 實數 vs 複數 | **0.047 mHa** | ✅ **VMC 化學精度達成！** |
| **SQD 整合** | Random vs NQS | **0.000 mHa** | ✅ **精確 FCI 能量** |

### 最終結論

🎉 **化學精度已達成！**

```
目標:     1.6 mHa (化學精度)
實數 NQS: 20.531 mHa ❌
複數 NQS:  0.047 mHa ✅ (提升 435 倍)
```

**成功配方**：
1. ComplexFFNNNQS（振幅 + 相位網路）
2. 粒子數約束 N=2
3. 足夠訓練時間（~2000 epochs）

---

## 參考資料

### 論文

1. Carleo & Troyer, Science 355, 602 (2017) - 原始 NQS 論文
2. Sorella, PRL 80, 4558 (1998) - Stochastic Reconfiguration

### 程式碼

- VMC Trainer: `src/training/vmc_trainer.py`
- FFNN NQS: `src/nqs_models/ffn_nqs.py`
- Transformer NQS: `src/nqs_models/transformer_nqs.py`
- Hamiltonian: `src/sqd_interface/hamiltonian.py`

### Git 提交

- `7ccc8c1` - feat: VMC training pipeline with correct energy reference fix

---

*最後更新：2024-11-28 (新增實驗七：複數波函數測試，實驗八：SQD 整合測試)*
